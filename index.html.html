<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Palavra da Li√ß√£o ‚Äî Termo Adventista</title>
  <meta name="description" content="Jogo estilo Termo/Wordle para usar com a li√ß√£o da semana. Configure a palavra, acrescente um verso/dica e compartilhe o resultado." />
  <style>
    :root{
      --bg:#0b0f0e;            /* fundo escuro, discreto */
      --panel:#111716;         /* cart√µes */
      --text:#e9f1ee;          /* texto principal */
      --muted:#98a6a1;         /* texto secund√°rio */
      --accent:#4caf50;        /* bot√µes e √™nfases */
      --tile:#1a2321;          /* quadrados vazios */
      --tile-border:#2b3532;   /* bordas dos quadrados */
      --correct:#2ecc71;       /* verde */
      --present:#f1c40f;       /* amarelo */
      --absent:#546e7a;        /* cinza frio */
      --warn:#ff7675;          /* avisos */
      --focus:#80cbc4;         /* foco */
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1100px 600px at 100% -10%, rgba(76,175,80,.10), transparent 60%),
                  radial-gradient(1200px 800px at -10% 120%, rgba(241,196,15,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:18px 16px; position:sticky; top:0; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,15,14,.9), rgba(11,15,14,.7));
      border-bottom:1px solid #1f2624;
      z-index:50;
    }
    h1{
      margin:0; font-size: clamp(18px, 2.6vw, 26px); letter-spacing:.5px; font-weight:700;
      display:flex; align-items:center; gap:10px;
    }
    h1 span.logo{display:inline-grid; place-items:center; width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg, var(--accent), #7fd67d); color:#0a0e0d; font-weight:800}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    button{appearance:none; border:none; background:var(--panel); color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; box-shadow: var(--shadow); border:1px solid #1e2624; font-weight:600}
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    button.primary{background:var(--accent); color:#07110f}
    button.ghost{background:transparent; border:1px solid #2a332f}

    main{max-width:720px; margin:24px auto; padding:0 16px 32px}
    .subtitle{margin:6px 0 16px; color:var(--muted); font-size:.95rem}

    .grid{display:grid; gap:8px; justify-content:center; margin:18px auto 12px}
    .row{display:grid; grid-template-columns: repeat(var(--cols), 56px); gap:8px}
    .tile{width:56px; height:56px; border-radius:10px; border:1px solid var(--tile-border); background:var(--tile); display:grid; place-items:center; font-weight:800; font-size:24px; text-transform:uppercase; letter-spacing:1px; position:relative; transform-style:preserve-3d; transition: transform .4s ease}
    .tile.filled{border-color:#3b4744}
    .tile.flip{transform:rotateX(180deg)}
    .tile[data-state="correct"]{background:var(--correct); border-color:transparent; color:#04130a}
    .tile[data-state="present"]{background:var(--present); border-color:transparent; color:#221a02}
    .tile[data-state="absent"]{background:var(--absent); border-color:transparent; color:#0e1416}

    .keyboard{display:grid; gap:8px; grid-template-rows: auto auto auto; justify-content:center; margin-top:10px}
    .keyrow{display:flex; gap:8px; justify-content:center}
    .key{min-width:36px; height:48px; padding:0 10px; border-radius:10px; background:#1b2422; color:var(--text); border:1px solid #2a332f; display:grid; place-items:center; font-weight:700; cursor:pointer; user-select:none}
    .key[data-state="correct"]{background:var(--correct); color:#04130a}
    .key[data-state="present"]{background:var(--present); color:#221a02}
    .key[data-state="absent"]{background:var(--absent); color:#0e1416}
    .key.wide{min-width:64px}

    .info{min-height:24px; margin:10px 0 2px; color:var(--muted)}
    .info strong{color:var(--focus)}

    .card{background:var(--panel); border:1px solid #1e2624; border-radius:var(--radius); box-shadow:var(--shadow)}
    .pad{padding:16px}

    dialog{background:var(--panel); border:1px solid #26302d; color:var(--text); border-radius:16px; width:min(680px, 92vw)}
    dialog::backdrop{background: rgba(0,0,0,.6)}
    .dialog-header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; border-bottom:1px solid #202826}
    .dialog-body{padding:14px}
    .dialog-footer{display:flex; gap:8px; justify-content:flex-end; padding:12px 14px; border-top:1px solid #202826}

    label{display:block; margin:10px 0 6px; font-weight:600}
    input[type="text"], textarea{width:100%; padding:12px 12px; border-radius:12px; background:#0e1413; color:var(--text); border:1px solid #2a332f; outline:none}
    textarea{min-height:96px; resize:vertical}
    .grid2{display:grid; gap:12px; grid-template-columns:1fr 1fr}
    @media (max-width:700px){ .grid2{grid-template-columns:1fr} }

    footer{max-width:720px; margin:28px auto; padding:0 16px 40px; color:var(--muted); font-size:.9rem}
    footer a{color:var(--focus); text-decoration:none}

    .pill{display:inline-flex; align-items:center; gap:8px; background:#0f1514; border:1px solid #1f2826; border-radius:999px; padding:6px 10px; margin:6px 4px 0 0; font-size:.9rem}

    .badge{font-weight:800; background:linear-gradient(135deg, #7fd67d, var(--accent)); color:#052219; border-radius:999px; padding:2px 8px;}
  </style>
</head>
<body>
  <header>
    <h1><span class="logo">‚ú¶</span> Palavra da Li√ß√£o <span class="badge">Beta</span></h1>
    <div class="controls">
      <button id="btnHint" class="ghost" title="Ver dica/verso">üí° Dica</button>
      <button id="btnShare" class="ghost" title="Compartilhar resultado">üì§ Compartilhar</button>
      <button id="btnReset" class="ghost" title="Reiniciar partida">üîÑ Reiniciar</button>
      <button id="btnConfig" class="primary" title="Configurar palavra, t√≠tulo e verso">‚öôÔ∏è Config</button>
      <button id="btnTests" class="ghost" title="Executar testes">üß™ Testes</button>
    </div>
  </header>

  <main>
    <div class="card pad">
      <div class="subtitle">Um jogo di√°rio para a <strong>Li√ß√£o da Escola Sabatina</strong>. Defina uma palavra-chave da li√ß√£o (ex.: <em>gra√ßa</em>, <em>f√©</em>, <em>salom√£o</em>) e convide o grupo a descobrir em at√© 6 tentativas.</div>
      <div id="meta" class="pill" aria-live="polite">Li√ß√£o: <strong id="lessonTitle">Fidelidade</strong> ‚Ä¢ Letras: <strong id="letterCount">5</strong></div>
      <div class="info" id="info" role="status" aria-live="polite"></div>
      <div id="grid" class="grid" aria-label="tabuleiro"></div>
      <div id="keyboard" class="keyboard" aria-label="teclado virtual"></div>
    </div>
  </main>

  <footer>
    Dica: letras com acentos (√°, √©, √£, √ß) s√£o <strong>aceitas</strong>, mas a confer√™ncia ignora acentos para facilitar. <br/>
    <details style="margin-top:8px">
      <summary>Como usar com seu grupo da Li√ß√£o</summary>
      <ol>
        <li>Clique em <strong>‚öôÔ∏è Config</strong> e defina a <em>palavra</em>, o <em>t√≠tulo da li√ß√£o</em> e (opcional) um <em>verso-chave/dica</em>.</li>
        <li>Use <strong>Gerar link</strong> para criar uma URL com a resposta codificada (letra mi√∫da: n√£o √© 100% √† prova de curiosos).</li>
        <li>Envie o link ao seu grupo. Cada pessoa joga no pr√≥prio celular.</li>
        <li>Depois, toque <strong>üì§ Compartilhar</strong> para copiar o quadradinho de cores e comemorar nos grupos. üòâ</li>
      </ol>
    </details>
  </footer>

  <!-- Dica / Verso -->
  <dialog id="hintModal">
    <div class="dialog-header">
      <strong>üí° Dica ‚Äî Verso-chave</strong>
      <button onclick="this.closest('dialog').close()" class="ghost">Fechar</button>
    </div>
    <div class="dialog-body" id="hintBody">Sem dica ainda. Abra ‚öôÔ∏è Config para adicionar um verso ou refer√™ncia.</div>
    <div class="dialog-footer">
      <button onclick="document.getElementById('hintModal').close()" class="primary">Entendi</button>
    </div>
  </dialog>

  <!-- Copiar manualmente (fallback) -->
  <dialog id="copyModal">
    <div class="dialog-header">
      <strong id="copyTitle">Copiar manualmente</strong>
      <button onclick="this.closest('dialog').close()" class="ghost">Fechar</button>
    </div>
    <div class="dialog-body">
      <p id="copyHelp" class="subtitle">Selecione o conte√∫do abaixo, pressione <strong>Ctrl/Cmd+C</strong> e cole onde desejar.</p>
      <textarea id="copyArea" readonly></textarea>
      <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
        <button id="btnSelectAll" class="ghost">Selecionar tudo</button>
        <button id="btnCopyFallback" class="primary">Copiar (fallback)</button>
        <button id="btnDownloadTxt" class="ghost">Baixar .txt</button>
        <a id="btnOpenLink" class="ghost" href="#" target="_blank" rel="noopener" style="display:none; text-decoration:none; line-height:40px; padding:10px 12px; border-radius:12px; border:1px solid #2a332f">Abrir link</a>
      </div>
    </div>
  </dialog>

  <!-- Configura√ß√µes -->
  <dialog id="configModal">
    <form method="dialog">
      <div class="dialog-header">
        <strong>‚öôÔ∏è Configura√ß√µes da Li√ß√£o</strong>
        <div style="display:flex; gap:8px">
          <button class="ghost" id="btnGenerateLink" type="button">Gerar link</button>
          <button class="primary" id="btnApply" value="apply">Aplicar</button>
          <button class="ghost" value="cancel">Fechar</button>
        </div>
      </div>
      <div class="dialog-body">
        <div class="grid2">
          <div>
            <label for="wordInput">Palavra (sem espa√ßos)</label>
            <input id="wordInput" type="text" maxlength="16" placeholder="Ex.: gra√ßa, f√©, s√°bado, salom√£o" />
            <div class="subtitle">Letras: <strong id="cfgLetters">0</strong> ‚Ä¢ Dica: use uma √∫nica palavra curta (4‚Äì10 letras).</div>
          </div>
          <div>
            <label for="titleInput">T√≠tulo da li√ß√£o</label>
            <input id="titleInput" type="text" maxlength="80" placeholder="Ex.: Fidelidade Radical" />
          </div>
        </div>
        <label for="hintInput">Verso-chave / Dica</label>
        <textarea id="hintInput" placeholder="Ex.: 'S√™ fiel at√© √† morte, e dar-te-ei a coroa da vida.' (Ap 2:10)"></textarea>
        <div class="subtitle">Privacidade: com este site em arquivo √∫nico, a palavra fica salva no link ou no seu navegador. Para mais sigilo, troque a palavra com frequ√™ncia.</div>
      </div>
    </form>
  </dialog>

  <!-- Testes -->
  <dialog id="testsModal">
    <div class="dialog-header">
      <strong>üß™ Testes autom√°ticos</strong>
      <button onclick="this.closest('dialog').close()" class="ghost">Fechar</button>
    </div>
    <div class="dialog-body">
      <div id="testsOutput" style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace"></div>
    </div>
    <div class="dialog-footer">
      <button class="primary" id="btnRunTests">Executar testes novamente</button>
    </div>
  </dialog>

  <script>
    // ===================== Utilidades =====================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const Storage = {
      read(key, dflt){ try{ return JSON.parse(localStorage.getItem(key)) ?? dflt }catch{ return dflt } },
      write(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)) }catch{} }
    }

    // Normaliza: remove acentos, trata √á -> C, mant√©m s√≥ letras
    function normalizeLetters(str){
      if(!str) return '';
      const cleaned = str
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // remove diacr√≠ticos
        .replace(/[√ß√á]/g,'c')
        .replace(/[^a-zA-Z]/g,'');
      return cleaned.toLowerCase();
    }

    // Mant√©m visual com acento, mas for√ßa mai√∫sculas
    function prettyUpper(str){ return (str||'').toLocaleUpperCase('pt-BR'); }

    // Base64 compat√≠vel com unicode
    function b64e(str){ return btoa(unescape(encodeURIComponent(str))) }
    function b64d(str){ try{ return decodeURIComponent(escape(atob(str))) }catch{ return '' } }

    function qsParam(name){ const url = new URL(location.href); return url.searchParams.get(name) }

    // ===================== Estado do Jogo =====================
    const DEFAULTS = {
      title: 'Fidelidade',
      wordRaw: 'GRA√áA',
      hint: '‚ÄúS√™ fiel at√© √† morte, e dar-te-ei a coroa da vida.‚Äù (Ap 2:10)'
    };

    const persisted = Storage.read('termoAdventista.config', {});

    // Carrega de URL se houver
    let cfg = {
      title: b64d(qsParam('t')) || persisted.title || DEFAULTS.title,
      wordRaw: b64d(qsParam('w')) || persisted.wordRaw || DEFAULTS.wordRaw,
      hint: b64d(qsParam('h')) || persisted.hint || DEFAULTS.hint,
    };

    // Palavra alvo (normalizada p/ l√≥gica) e comprimento
    let targetRaw = cfg.wordRaw.trim();
    function sanitizedRaw(str){
      // Remove espa√ßos/h√≠fens, mant√©m acentos/√ß para exibir bonito
      return prettyUpper((str||'').replace(/[^\p{L}]/gu, ''));
    }
    targetRaw = sanitizedRaw(targetRaw);
    let target = normalizeLetters(targetRaw);

    const attemptsMax = 6;
    let cols = Math.min(Math.max(target.length, 4), 10); // 4..10

    let state = {
      row: 0,
      col: 0,
      guesses: Array.from({length: attemptsMax}, () => ''),
      status: Array.from({length: attemptsMax}, () => Array(cols).fill('')),
      finished: false,
      win: false,
    };

    function saveProgress(){
      const key = 'termoAdventista.'+b64e(target);
      Storage.write(key, state);
    }

    function loadProgress(){
      const key = 'termoAdventista.'+b64e(target);
      const s = Storage.read(key);
      if(s && s.guesses && s.status){ state = s; }
    }

    // ===================== Clipboard seguro com fallback =====================
    async function writeTextSafe(text, {hintTitle='Copiar manualmente', hintIsLink=false}={}){
      // 1) Web Share API (m√≥vel), se dispon√≠vel
      try{
        if(navigator.share && /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)){
          await navigator.share({ text });
          setInfo('Compartilhado via sistema.');
          return {ok:true, method:'share'};
        }
      }catch(e){ /* ignora e tenta pr√≥ximos */ }

      // 2) Clipboard API (contexto seguro e com permiss√£o)
      if (window.isSecureContext && navigator.clipboard && navigator.clipboard.writeText){
        try{
          await navigator.clipboard.writeText(text);
          setInfo('Conte√∫do copiado para a √°rea de transfer√™ncia.');
          return {ok:true, method:'clipboard'};
        }catch(e){
          // Pode falhar por pol√≠tica de permiss√µes; prossegue para fallback
        }
      }

      // 3) Fallback: execCommand("copy")
      try{
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly','');
        ta.style.position='fixed'; ta.style.top='-9999px';
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        if(ok){ setInfo('Conte√∫do copiado (fallback).'); return {ok:true, method:'execCommand'}; }
      }catch(e){ /* segue para modal */ }

      // 4) √öltimo recurso: abrir modal para copiar manualmente
      openCopyModal(text, {title: hintTitle, isLink: hintIsLink});
      setInfo('Copie manualmente no modal aberto.');
      return {ok:false, method:'manual'};
    }

    function openCopyModal(text, {title='Copiar manualmente', isLink=false}={}){
      $('#copyTitle').textContent = title;
      $('#copyArea').value = text;
      $('#copyHelp').innerHTML = isLink ? 'Se preferir, clique em <strong>Abrir link</strong> ou selecione e copie o endere√ßo abaixo.' : 'Selecione o conte√∫do e pressione <strong>Ctrl/Cmd+C</strong> para copiar.';
      const a = $('#btnOpenLink');
      if(isLink){ a.style.display='inline-block'; a.href = text; } else { a.style.display='none'; a.href = '#'; }
      $('#copyModal').showModal();
      setTimeout(()=>{ $('#copyArea').focus(); $('#copyArea').select(); }, 60);
    }

    function downloadText(filename, content){
      const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // ===================== Constru√ß√£o da UI =====================
    function buildGrid(){
      const grid = $('#grid');
      grid.innerHTML = '';
      grid.style.setProperty('--cols', cols);
      for(let r=0;r<attemptsMax;r++){
        const row = document.createElement('div');
        row.className = 'row';
        row.dataset.row = r;
        for(let c=0;c<cols;c++){
          const t = document.createElement('div');
          t.className = 'tile';
          t.dataset.row = r; t.dataset.col = c;
          row.appendChild(t);
        }
        grid.appendChild(row);
      }
    }

    const KEY_ROWS = [
      [...'QWERTYUIOP'],
      [...'ASDFGHJKL√á'],
      ['ENTER', ...'ZXCVBNM', '‚å´']
    ];

    function buildKeyboard(){
      const kb = $('#keyboard');
      kb.innerHTML = '';
      kb.className = 'keyboard';
      KEY_ROWS.forEach((row)=>{
        const line = document.createElement('div');
        line.className = 'keyrow';
        row.forEach(k=>{
          const b = document.createElement('div');
          b.className = 'key';
          b.textContent = k.length===1 ? k : (k==='ENTER'?'Enter':'Apagar');
          if(k.length>1) b.classList.add('wide');
          b.dataset.key = k;
          b.addEventListener('click', () => handleKey(k));
          line.appendChild(b);
        });
        kb.appendChild(line);
      });
    }

    function updateMeta(){
      $('#lessonTitle').textContent = cfg.title || '‚Äî';
      $('#letterCount').textContent = cols;
      $('#hintBody').textContent = cfg.hint || 'Sem dica no momento.';
      $('#info').textContent = `Descubra a palavra em ${attemptsMax} tentativas.`;
      $('#wordInput').value = targetRaw;
      $('#titleInput').value = cfg.title || '';
      $('#hintInput').value = cfg.hint || '';
      $('#cfgLetters').textContent = cols;
    }

    function renderAll(){
      for(let r=0;r<attemptsMax;r++){
        const guess = state.guesses[r] || '';
        for(let c=0;c<cols;c++){
          const tile = document.querySelector(`.tile[data-row="${r}"][data-col="${c}"]`);
          const ch = guess[c] || '';
          tile.textContent = ch ? prettyUpper(ch) : '';
          const st = state.status[r][c];
          tile.dataset.state = st || '';
          tile.classList.toggle('filled', !!ch);
        }
      }
      updateKeyboardColors();
      saveProgress();
    }

    function setInfo(msg, type=''){
      const info = $('#info');
      info.textContent = msg;
      info.style.color = type==='warn'? 'var(--warn)' : 'var(--muted)';
    }

    // ===================== L√≥gica do jogo =====================
    function handleKey(k){
      if(state.finished) return;
      if(k==='ENTER') return onEnter();
      if(k==='‚å´') return onBackspace();
      if(k.length===1){ addLetter(k); }
    }

    function addLetter(ch){
      if(state.col>=cols) return;
      const letter = normalizeLetters(ch)[0];
      if(!letter) return; // ignora n√£o-letras
      const r = state.row, c = state.col;
      state.guesses[r] = (state.guesses[r] || '') + letter;
      state.col++;
      renderAll();
    }

    function onBackspace(){
      const r = state.row;
      if(state.col<=0) return;
      state.guesses[r] = state.guesses[r].slice(0,-1);
      state.col--;
      renderAll();
    }

    function onEnter(){
      const r = state.row;
      const guess = (state.guesses[r]||'');
      if(guess.length<cols){ setInfo('Palavra incompleta.', 'warn'); return; }
      // Avaliar
      const res = evaluate(guess, target);
      state.status[r] = res;
      flipRow(r, res);
      const isCorrect = res.every(s=>s==='correct');
      if(isCorrect){
        state.finished = true; state.win = true;
        setTimeout(()=>{
          setInfo('Parab√©ns! Voc√™ acertou.');
          $('#hintModal').showModal();
        }, 450);
      } else if(r===attemptsMax-1){
        state.finished = true; state.win = false;
        setTimeout(()=>{
          setInfo(`Fim de jogo! A palavra era ${prettyUpper(targetRaw)}.`);
          $('#hintModal').showModal();
        }, 450);
      } else {
        state.row++; state.col=0;
        setInfo('Boa! Continue.');
      }
      renderAll();
    }

    function evaluate(guess, answer){
      // Wordle-style: primeiro marca corretos, depois presentes com contagem
      const L = answer.length; // usa comprimento da resposta
      const res = Array(L).fill('absent');
      const a = answer.split('');
      const g = guess.split('');
      const used = Array(L).fill(false);

      // Marca corretos
      for(let i=0;i<L;i++){
        if(g[i]===a[i]){ res[i]='correct'; used[i]=true; g[i] = '‚úì'; }
      }
      // Mapa de frequ√™ncias restantes
      const freq = {};
      for(let i=0;i<L;i++){
        if(!used[i]){ freq[a[i]] = (freq[a[i]]||0)+1; }
      }
      // Marca presentes
      for(let i=0;i<L;i++){
        const ch = guess[i];
        if(res[i]==='correct') continue;
        if(freq[ch]>0){ res[i] = 'present'; freq[ch]--; }
      }
      return res;
    }

    function flipRow(r, res){
      for(let c=0;c<cols;c++){
        const tile = document.querySelector(`.tile[data-row="${r}"][data-col="${c}"]`);
        setTimeout(()=>{
          tile.classList.add('flip');
          tile.dataset.state = res[c];
        }, c*100);
      }
      setTimeout(()=>{
        // remove classe flip para pr√≥xima linha n√£o herdar estado 3D
        for(let c=0;c<cols;c++){
          const tile = document.querySelector(`.tile[data-row="${r}"][data-col="${c}"]`);
          tile.classList.remove('flip');
        }
      }, cols*120 + 400);
    }

    function updateKeyboardColors(){
      const map = {}; // letra -> highest state
      const rank = { 'absent':0, 'present':1, 'correct':2 };
      for(let r=0;r<attemptsMax;r++){
        const guess = state.guesses[r]||'';
        for(let c=0;c<guess.length;c++){
          const ch = guess[c].toUpperCase();
          const s = state.status[r][c];
          if(!s) continue;
          if(!(ch in map) || rank[s] > rank[map[ch]]) map[ch] = s;
        }
      }
      $$('.key').forEach(k=>{
        const ch = (k.dataset.key || '').toUpperCase();
        const s = map[ch];
        k.dataset.state = s || '';
      })
    }

    // ===================== Eventos globais =====================
    document.addEventListener('keydown', (ev)=>{
      const key = ev.key;
      if(key==='Enter') return handleKey('ENTER');
      if(key==='Backspace') return handleKey('‚å´');
      if(/^[a-zA-Z√ß√á]$/.test(key)) return handleKey(key.toUpperCase());
    });

    $('#btnHint').addEventListener('click', ()=> $('#hintModal').showModal());

    $('#btnReset').addEventListener('click', ()=>{
      if(confirm('Reiniciar a partida atual?')){
        state = {
          row:0, col:0,
          guesses: Array.from({length: attemptsMax}, () => ''),
          status: Array.from({length: attemptsMax}, () => Array(cols).fill('')),
          finished:false, win:false,
        };
        setInfo('Partida reiniciada.');
        renderAll();
      }
    });

    $('#btnShare').addEventListener('click', async ()=>{
      const title = cfg.title ? `Li√ß√£o: ${cfg.title}` : 'Palavra da Li√ß√£o';
      const header = `${title} ‚Äî ${state.win? state.row+"/":'X/'}${attemptsMax}`;
      const blocks = state.status.map((row,i)=>{
        if(!row.some(Boolean)) return '';
        return row.map(s=> s==='correct'?'üü©': s==='present'?'üü®':'‚¨ú').join('');
      }).filter(Boolean).join('\n');
      const text = `${header}\n${blocks}`.trim();
      await writeTextSafe(text, {hintTitle:'Copie seu resultado'});
    });

    $('#btnConfig').addEventListener('click', ()=>{
      updateMeta();
      $('#configModal').showModal();
    });

    $('#btnGenerateLink').addEventListener('click', async ()=>{
      // L√™ campos atuais (sem fechar o modal)
      const raw = sanitizedRaw($('#wordInput').value || targetRaw);
      const title = $('#titleInput').value.trim() || cfg.title || '';
      const hint = $('#hintInput').value.trim() || cfg.hint || '';
      const url = new URL(location.href);
      url.searchParams.set('w', b64e(raw));
      url.searchParams.set('t', title? b64e(title):'');
      url.searchParams.set('h', hint? b64e(hint):'');
      const link = url.toString();
      await writeTextSafe(link, {hintTitle:'Copie o link (ou abra abaixo)', hintIsLink:true});
      // Tamb√©m atualiza a barra do navegador (n√£o obrigat√≥rio)
      try{ history.replaceState(null, '', link); }catch{}
    });

    $('#btnApply').addEventListener('click', (ev)=>{
      ev.preventDefault();
      const raw = sanitizedRaw($('#wordInput').value || targetRaw);
      const nrm = normalizeLetters(raw);
      if(nrm.length<4 || nrm.length>10){
        alert('Use uma palavra entre 4 e 10 letras.');
        return;
      }
      cfg.title = $('#titleInput').value.trim() || '';
      cfg.hint = $('#hintInput').value.trim() || '';
      cfg.wordRaw = raw;
      Storage.write('termoAdventista.config', cfg);

      // Atualiza alvo e reinicia jogo
      targetRaw = raw; target = normalizeLetters(targetRaw); cols = target.length;
      state = {
        row:0, col:0,
        guesses: Array.from({length: attemptsMax}, () => ''),
        status: Array.from({length: attemptsMax}, () => Array(cols).fill('')),
        finished:false, win:false,
      };
      buildGrid(); buildKeyboard(); updateMeta(); renderAll();
      $('#configModal').close();
      setInfo('Configura√ß√µes aplicadas. Boa partida!');
    });

    // ====== Eventos do modal de c√≥pia ======
    $('#btnSelectAll').addEventListener('click', ()=>{ $('#copyArea').focus(); $('#copyArea').select(); });
    $('#btnCopyFallback').addEventListener('click', ()=>{
      $('#copyArea').focus(); $('#copyArea').select();
      try{
        const ok = document.execCommand('copy');
        setInfo(ok? 'Copiado (fallback).' : 'N√£o foi poss√≠vel copiar automaticamente, selecione e use Ctrl/Cmd+C.');
      }catch{ setInfo('Selecione e use Ctrl/Cmd+C para copiar.'); }
    });
    $('#btnDownloadTxt').addEventListener('click', ()=>{
      const text = $('#copyArea').value || '';
      const name = (document.title||'resultado').replace(/\s+/g,'_').toLowerCase()+'.txt';
      downloadText(name, text);
    });

    // ===================== Testes =====================
    function runUnitTests(){
      const out = [];
      function assertEqual(name, a, b){ const ok = JSON.stringify(a)===JSON.stringify(b); out.push(`${ok?'‚úÖ':'‚ùå'} ${name}\n  esperado: ${JSON.stringify(b)}\n  obtido:  ${JSON.stringify(a)}`); }

      // Teste 1: normalizeLetters
      assertEqual('normalizeLetters("GRA√áA")', normalizeLetters('GRA√áA'), 'graca');
      assertEqual('normalizeLetters("f√©123")', normalizeLetters('f√©123'), 'fe');
      assertEqual('normalizeLetters("Salom√£o")', normalizeLetters('Salom√£o'), 'salomao');

      // Teste 2: evaluate ‚Äî tudo correto
      (function(){
        const savedCols = cols; cols = 4;
        const res = evaluate('casa','casa');
        cols = savedCols;
        assertEqual('evaluate("casa","casa")', res, ['correct','correct','correct','correct']);
      })();

      // Teste 3: evaluate ‚Äî letras repetidas controladas
      (function(){
        // resposta: GRACA (g r a c a), palpite: ARARA (a r a r a)
        const savedCols = cols; cols = 5;
        const res = evaluate('arara','graca');
        cols = savedCols;
        assertEqual('evaluate("arara","graca")', res, ['absent','correct','correct','absent','correct']);
      })();

      // Teste 4: evaluate ‚Äî presentes vs ausentes
      (function(){
        const savedCols = cols; cols = 5;
        const res = evaluate('sabio','sabio');
        cols = savedCols;
        assertEqual('evaluate("sabio","sabio")', res, ['correct','correct','correct','correct','correct']);
      })();

      $('#testsOutput').textContent = out.join('\n\n');
      return out.every(l => l.startsWith('‚úÖ'));
    }

    $('#btnTests').addEventListener('click', ()=>{ runUnitTests(); $('#testsModal').showModal(); });
    $('#btnRunTests').addEventListener('click', ()=>{ runUnitTests(); });

    // ===================== Inicializa√ß√£o =====================
    function init(){
      // Prepara UI
      buildGrid();
      buildKeyboard();
      updateMeta();
      loadProgress();
      renderAll();
      setInfo('Descubra a palavra em 6 tentativas.');
    }

    init();
  </script>
</body>
</html>
